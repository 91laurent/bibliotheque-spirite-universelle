<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biblioth√®que Spirite Universelle</title>
    
    <!-- Styles Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Polices Google -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Babel pour compiler React dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles Personnalis√©s -->
    <style>
      body { font-family: 'Lato', sans-serif; background-color: #fdfbf7; margin: 0; padding: 0; }
      .font-serif { font-family: 'Crimson Text', serif; }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

      /* Texture papier */
      .bg-paper-pattern {
        background-color: #ffffff;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      }

      .animate-fade-in { animation: fadeIn 0.5s ease-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Loading Spinner */
      .loader { border: 3px solid #f3f3f3; border-top: 3px solid #d97706; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      #startup-error { display: none; padding: 20px; text-align: center; color: #b91c1c; background: #fee2e2; margin: 20px; border-radius: 8px; border: 1px solid #fca5a5; }
    </style>

    <!-- Import Map Strict -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@latest",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>

    <script>
        window.process = { env: {} };
        setTimeout(() => {
            const root = document.getElementById('root');
            if (!root || root.innerHTML.trim() === '') {
                document.getElementById('startup-error').style.display = 'block';
            }
        }, 3000);
    </script>
</head>
<body>
    <div id="root"></div>
    <div id="startup-error">
        <h2 class="font-bold text-xl mb-2">Probl√®me de chargement</h2>
        <p>L'application n'a pas pu d√©marrer. Essayez avec un autre navigateur (Firefox) ou v√©rifiez votre connexion.</p>
    </div>

    <script type="text/babel" data-type="module">
        /** @jsx React.createElement */
        /** @jsxFrag React.Fragment */
        
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // Plus besoin de GoogleGenAI - on utilise Cloudflare Worker maintenant
        // import { GoogleGenAI } from "@google/genai";

        // ==========================================
        // CONFIGURATION & DONN√âES
        // ==========================================
        
        // Cl√© API maintenant s√©curis√©e dans Cloudflare Worker
        const WORKER_URL = "https://bibliotheque-spirite-api.laurent91210.workers.dev/"; 

        const LIBRARY = [
            // CODIFICATION (KARDEC)
            { id: 'esprits', category: 'codification', author: 'Allan Kardec', title: 'Le Livre des Esprits', subtitle: 'Philosophie Spiritualiste', description: 'Principes de la doctrine spirite, immortalit√© de l\'√¢me, nature des esprits et leurs rapports avec les hommes.', color: 'amber' },
            { id: 'mediums', category: 'codification', author: 'Allan Kardec', title: 'Le Livre des M√©diums', subtitle: 'Guide des √âvocateurs', description: 'L\'enseignement sp√©cial des esprits sur la th√©orie de tous les genres de manifestations.', color: 'purple' },
            { id: 'evangile', category: 'codification', author: 'Allan Kardec', title: 'L\'√âvangile selon le Spiritisme', subtitle: 'Morale Chr√©tienne', description: 'Explication des maximes morales du Christ, leur concordance avec le spiritisme.', color: 'emerald' },
            { id: 'ciel', category: 'codification', author: 'Allan Kardec', title: 'Le Ciel et l\'Enfer', subtitle: 'Justice Divine', description: 'Examen compar√© des doctrines sur le passage de la vie corporelle √† la vie spirituelle.', color: 'blue' },
            { id: 'genese', category: 'codification', author: 'Allan Kardec', title: 'La Gen√®se', subtitle: 'Les Miracles et les Pr√©dictions', description: 'La doctrine spirite sur la cr√©ation, les miracles et les pr√©dictions.', color: 'stone' },
            { id: 'revue', category: 'codification', author: 'Allan Kardec & Continuateurs', title: 'La Revue Spirite', subtitle: 'Journal d\'√âtudes (1858-1876)', description: 'Le laboratoire du spiritisme. Inclut les ann√©es Kardec (1858-1869) et la p√©riode de transition (1870-1876).', color: 'stone' },
            
            // CONTINUATEURS
            { id: 'denis', category: 'continuateurs', author: 'L√©on Denis', title: 'Apr√®s la Mort', subtitle: 'Philosophie & Po√©sie', description: 'Un expos√© magistral de la doctrine, clair, po√©tique et touchant. Id√©al pour comprendre le sens de la vie.', color: 'indigo' },
            { id: 'delanne', category: 'continuateurs', author: 'Gabriel Delanne', title: 'Le Ph√©nom√®ne Spirite', subtitle: 'Preuves Scientifiques', description: 'Une approche rigoureuse et scientifique d√©montrant l\'existence de l\'√¢me par les faits.', color: 'cyan' },
            { id: 'xavier', category: 'continuateurs', author: 'Chico Xavier', title: 'Nosso Lar', subtitle: 'La Vie dans le Monde Spirituel', description: 'Le r√©cit du m√©decin Andr√© Luiz sur son arriv√©e et sa vie dans une colonie spirituelle.', color: 'rose' },
            { id: 'flammarion', category: 'continuateurs', author: 'Camille Flammarion', title: 'La Mort et son Myst√®re', subtitle: 'Astronomie & Au-del√†', description: 'L\'immense astronome explore les preuves de la survivance avec la rigueur du savant.', color: 'slate' },
            { id: 'philippe', category: 'continuateurs', author: 'Ma√Ætre Philippe de Lyon', title: 'Vie et Paroles', subtitle: 'Enseignements & Gu√©risons', description: 'Recueil des paroles et des actes de gu√©rison de Monsieur Philippe. Spiritualit√© de l\'humilit√©.', color: 'teal' },
            
            // NOUVEAUX AUTEURS
            { id: 'doyle', category: 'continuateurs', author: 'Arthur Conan Doyle', title: 'Histoire du Spiritisme', subtitle: 'Enqu√™te Historique', description: 'Le c√©l√®bre cr√©ateur de Sherlock Holmes retrace l\'histoire compl√®te du mouvement spirite.', color: 'orange' },
            { id: 'geley', category: 'continuateurs', author: 'Gustave Geley', title: 'L\'√ätre Subconscient', subtitle: 'Psychologie & M√©tapsychique', description: 'Une √©tude scientifique profonde sur la conscience, l\'ectoplasme et les facult√©s supra-normales.', color: 'zinc' },
            { id: 'pereira', category: 'continuateurs', author: 'Yvonne Pereira', title: 'M√©moires d\'un Suicid√©', subtitle: 'Roman M√©diumnique', description: 'Un r√©cit bouleversant sur le sort des suicid√©s dans l\'au-del√† et leur chemin vers la r√©demption.', color: 'red' }
        ];

        const AppView = { HOME: 'HOME', EXPLORER: 'EXPLORER', CHAT: 'CHAT' };
        
        // ==========================================
        // SERVICE IA - Maintenant via Cloudflare Worker
        // ==========================================
        // Plus besoin de getAiClient - tout passe par le Worker

        const cache = {};

        // R√©cup√©ration de la structure
        const getBookStructure = async (book) => {
            const cacheKey = `structure-${book.id}`;
            if (cache[cacheKey]) return cache[cacheKey];

            // Ajustement du prompt pour inclure les ann√©es 1870-1876 pour la Revue
            let prompt = `G√©n√®re la liste COMPLETE de tous les chapitres du livre "${book.title}" de ${book.author}. Sois exhaustif.`;

            if (book.title.includes("Revue Spirite")) {
                prompt = `G√©n√®re la liste des Ann√©es de la Revue Spirite, de 1858 jusqu'√† 1876 inclus. Format JSON attendu: { "chapters": [{ "id": "1858", "title": "Ann√©e 1858" }, { "id": "1876", "title": "Ann√©e 1876" }] }`;
            } else {
                prompt += ` Format JSON: { "chapters": [{ "id": "1", "title": "Titre du chapitre" }] }`;
            }

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gemini-1.5-flash",
                        contents: prompt,
                        config: { responseMimeType: "application/json" }
                    })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(result);
                const data = JSON.parse(text);
                const res = data.chapters || [];
                cache[cacheKey] = res;
                return res;
            } catch (e) {
                console.error(e);
                throw e;
            }
        };

        // R√©cup√©ration du contenu
        const getChapterContent = async (book, chapterTitle) => {
            const cacheKey = `content-${book.id}-${chapterTitle}`;
            if (cache[cacheKey]) return cache[cacheKey];

            // Prompt adaptatif selon le style de l'auteur
            let promptInstruction = "Restitue le contenu d√©taill√© du chapitre. Sois exhaustif.";
            if (book.title.includes("Esprits")) {
                promptInstruction = "Liste TOUTES les questions et r√©ponses num√©rot√©es de ce chapitre. Ne fais pas de r√©sum√©, donne le texte complet.";
            } else if (book.title.includes("Revue Spirite")) {
                 promptInstruction = "Ceci est une ann√©e compl√®te de la Revue. S√©lectionne et restitue les articles les plus marquants, les communications spirites importantes et les faits majeurs de cette ann√©e (Janvier √† D√©cembre). Conserve le style d'√©poque.";
            } else if (book.title.includes("Nosso Lar") || book.author === "Yvonne Pereira") {
                promptInstruction = "Raconte l'histoire compl√®te de ce chapitre avec tous les d√©tails narratifs, les √©motions et les dialogues importants.";
            } else if (book.author === "L√©on Denis") {
                promptInstruction = "Restitue le texte avec toute sa profondeur philosophique et po√©tique. Ne r√©sume pas trop, garde la beaut√© du style.";
            } else if (book.author === "Gustave Geley" || book.author === "Camille Flammarion") {
                promptInstruction = "Restitue les analyses scientifiques, les cas observ√©s et les conclusions logiques de mani√®re rigoureuse.";
            } else if (book.title.includes("√âvangile")) {
                promptInstruction = "Liste tous les items et enseignements. Conserve les explications compl√®tes.";
            } else if (book.author === "Ma√Ætre Philippe de Lyon") {
                promptInstruction = "Rapporte fid√®lement les paroles, anecdotes et enseignements. Garde la simplicit√© du langage original.";
            }

            const prompt = `Livre: "${book.title}" (${book.author}). Chapitre/Ann√©e: "${chapterTitle}".
            Instruction: ${promptInstruction}
            Format JSON attendu: { "items": [{ "number": "1 ou Titre", "title": "Sujet/Question", "content": "Contenu COMPLET avec sauts de ligne" }] }.
            Important: Utilise des sauts de ligne (\\n) pour a√©rer le texte et respecter les paragraphes originaux.`;

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gemini-1.5-flash",
                        contents: prompt,
                        config: { responseMimeType: "application/json" }
                    })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(result);
                const data = JSON.parse(text);
                cache[cacheKey] = data.items || [];
                return data.items || [];
            } catch (e) {
                console.error(e);
                throw e;
            }
        };

        // Chat avec le contexte du livre
        const chatWithBook = async (book, history, message) => {
            let personality = `Tu es un expert du livre "${book.title}".`;
            if (book.author === "Chico Xavier" || book.author === "Yvonne Pereira") personality = "Tu es un esprit bienveillant racontant son exp√©rience dans l'au-del√†. Tu parles avec √©motion et charit√©.";
            if (book.author === "L√©on Denis") personality = "Tu empruntes le style √©loquent, po√©tique et philosophique de L√©on Denis.";
            if (book.author === "Allan Kardec") personality = "Tu es m√©thodique, rationnel et p√©dagogique, comme Allan Kardec.";
            if (book.title.includes("Revue Spirite")) personality = "Tu es le r√©dacteur de la Revue Spirite. Pour la p√©riode 1858-1869, tu es Allan Kardec. Pour la p√©riode suivante (1870-1876), tu parles au nom de la r√©daction et de Pierre-Ga√´tan Leymarie, continuant l'≈ìuvre du ma√Ætre.";
            if (book.author === "Ma√Ætre Philippe de Lyon") personality = "Tu es l'esprit de Ma√Ætre Philippe de Lyon. Tu parles avec une extr√™me humilit√©, de charit√©, de pri√®re et d'amour du prochain. Tu dis souvent 'Je ne suis rien', 'C'est le Ciel qui agit'.";
            if (book.author === "Arthur Conan Doyle") personality = "Tu es Sir Arthur Conan Doyle. Tu es un conteur n√©, curieux et passionn√© par les faits historiques du spiritisme.";
            if (book.author === "Gustave Geley") personality = "Tu es le Dr Gustave Geley. Tu as une approche clinique, biologique et rationnelle des ph√©nom√®nes.";

            const systemInstruction = `${personality} R√©ponds aux questions en te basant UNIQUEMENT sur le contenu et l'esprit de "${book.title}" (ou la vie de ${book.author}). Si la question n'est pas dans le livre, dis-le poliment.`;

            const response = await fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gemini-1.5-flash",
                    history,
                    message,
                    systemInstruction
                })
            });

            // Parser le streaming SSE
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            return {
                async *[Symbol.asyncIterator]() {
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                    if (text) yield { text };
                                } catch (e) { /* Ignorer les erreurs de parsing */ }
                            }
                        }
                    }
                }
            };
        };

        // ==========================================
        // COMPOSANTS UI
        // ==========================================

        const WelcomeModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border border-gray-100">
                        <div className="bg-amber-600 p-6 text-white text-center">
                            <h2 className="text-3xl font-serif font-bold mb-2">Biblioth√®que Spirite 2025</h2>
                            <p className="text-amber-100 text-sm uppercase tracking-widest">√âdition Num√©rique</p>
                        </div>
                        <div className="p-8 space-y-6">
                            <p className="text-gray-700 text-lg leading-relaxed text-center font-serif">
                                Cette application rassemble <strong>les ≈ìuvres fondamentales</strong> du Spiritisme : la Codification d'Allan Kardec ainsi que les √©crits majeurs de ses continuateurs (Denis, Delanne, Xavier, Doyle...).
                            </p>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-gray-50 p-4 rounded-xl border text-center">
                                    <span className="text-2xl block mb-2">üìñ</span>
                                    <h3 className="font-bold text-gray-900">Lecture</h3>
                                    <p className="text-xs text-gray-500">Contenu restitu√©</p>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-xl border text-center">
                                    <span className="text-2xl block mb-2">üí¨</span>
                                    <h3 className="font-bold text-gray-900">Dialogue</h3>
                                    <p className="text-xs text-gray-500">Posez vos questions</p>
                                </div>
                            </div>

                            <button 
                                onClick={onClose}
                                className="w-full py-4 bg-gray-900 text-white rounded-xl font-bold text-lg hover:bg-gray-800 transition shadow-lg transform hover:scale-[1.02]"
                            >
                                Entrer dans la Biblioth√®que
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExplorerView = ({ book }) => {
            const [structure, setStructure] = useState([]);
            const [selectedChapter, setSelectedChapter] = useState(null);
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setLoading(true);
                getBookStructure(book)
                    .then(setStructure)
                    .catch(() => alert("Erreur structure"))
                    .finally(() => setLoading(false));
                setSelectedChapter(null);
                setItems([]);
            }, [book]);

            useEffect(() => {
                if (selectedChapter) {
                    setLoading(true);
                    getChapterContent(book, selectedChapter.title)
                        .then(setItems)
                        .catch(() => alert("Erreur contenu"))
                        .finally(() => setLoading(false));
                }
            }, [selectedChapter]);

            return (
                <div className="flex flex-col md:flex-row gap-6 h-full animate-fade-in">
                    {/* Colonne Chapitres */}
                    <div className="w-full md:w-1/3 flex flex-col gap-4">
                        <div className={`bg-white border-l-4 border-${book.color}-500 rounded-lg shadow-sm p-4`}>
                            <h2 className="font-serif font-bold text-xl text-gray-900">{book.title}</h2>
                            <p className="text-sm text-gray-600 font-bold">{book.author}</p>
                            <p className="text-xs text-gray-500">{structure.length} sections trouv√©es</p>
                            <p className="text-xs text-amber-600 mt-2 italic">Acc√®s Int√©gral (IA)</p>
                        </div>

                        <div className="bg-white border rounded-lg h-[65vh] flex flex-col shadow-sm">
                            <div className="overflow-y-auto flex-1 p-2">
                                {loading && structure.length === 0 && <div className="p-4 text-center text-gray-400 italic">Analyse du livre...</div>}
                                {structure.map((c, i) => (
                                    <button key={i} onClick={() => setSelectedChapter(c)} className={`w-full text-left p-3 text-sm rounded border-b border-gray-50 last:border-0 transition-colors ${selectedChapter === c ? `bg-${book.color}-50 text-${book.color}-900 font-bold` : 'hover:bg-gray-50'}`}>
                                        {c.title}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Colonne Contenu */}
                    <div className="w-full md:w-2/3 bg-white border rounded-xl shadow-sm h-[80vh] flex flex-col overflow-hidden bg-paper-pattern relative">
                        {selectedChapter ? (
                            <React.Fragment>
                                <div className={`p-6 border-b bg-${book.color}-50/30 backdrop-blur sticky top-0 z-10`}>
                                    <h2 className="text-2xl font-serif text-gray-900">{selectedChapter.title}</h2>
                                    <p className="text-xs text-gray-500 uppercase tracking-wide">Contenu Int√©gral Restitu√©</p>
                                </div>
                                <div className="overflow-y-auto flex-1 p-6 space-y-6">
                                    {loading ? (
                                        <div className="flex flex-col items-center justify-center h-40 space-y-4">
                                            <div className="loader"></div>
                                            <p className="text-gray-500 font-serif italic">Restitution du texte en cours...</p>
                                        </div>
                                    ) : (
                                        items.map((item, idx) => (
                                            <div key={idx} className="group">
                                                <div className="flex items-baseline gap-3 mb-2">
                                                    <span className={`text-${book.color}-700 font-bold font-serif text-lg opacity-60`}>#{item.number}</span>
                                                    <h3 className="font-bold text-gray-900 text-lg leading-relaxed">{item.title}</h3>
                                                </div>
                                                <div className={`pl-4 border-l-2 border-${book.color}-200 ml-2 py-1`}>
                                                    {item.content.split('\n').map((paragraph, i) => (
                                                        <p key={i} className={`text-gray-700 font-serif text-lg leading-relaxed text-justify mb-3 ${paragraph.trim().startsWith('-') ? 'pl-4' : ''}`}>
                                                            {paragraph}
                                                        </p>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </React.Fragment>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-gray-400 p-8 text-center">
                                <span className="text-6xl mb-4 opacity-20">üìñ</span>
                                <p className="font-serif text-xl">S√©lectionnez un chapitre √† gauche pour lire.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ChatInterface = ({ book }) => {
            const [messages, setMessages] = useState([
                { id: '1', role: 'model', content: `Bonjour. Je suis pr√™t √† discuter du contenu de "${book.title}".` }
            ]);
            const [input, setInput] = useState('');
            const [isStreaming, setIsStreaming] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!input.trim() || isStreaming) return;

                const userMsg = { id: Date.now().toString(), role: 'user', content: input };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setIsStreaming(true);

                const history = messages.map(m => ({ role: m.role, parts: [{ text: m.content }] }));

                try {
                    const streamResult = await chatWithBook(book, history, userMsg.content);
                    const botId = (Date.now() + 1).toString();
                    setMessages(prev => [...prev, { id: botId, role: 'model', content: '' }]);

                    let fullText = "";
                    for await (const chunk of streamResult) {
                        const text = chunk.text || ""; 
                        fullText += text;
                        setMessages(prev => prev.map(m => m.id === botId ? { ...m, content: fullText } : m));
                    }
                } catch (error) {
                    console.error(error);
                    setMessages(prev => [...prev, { id: Date.now(), role: 'model', content: "D√©sol√©, je ne peux pas r√©pondre pour le moment." }]);
                } finally {
                    setIsStreaming(false);
                }
            };

            return (
                <div className="flex flex-col h-[85vh] bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div className={`p-4 bg-${book.color}-50 border-b flex items-center gap-3`}>
                        <div className={`w-3 h-3 rounded-full bg-${book.color}-500 animate-pulse`}></div>
                        <div>
                            <h2 className={`font-serif font-bold text-${book.color}-900`}>{book.title}</h2>
                            <p className="text-xs text-gray-500">Mode conversation</p>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50">
                        {messages.map((m) => (
                            <div key={m.id} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl shadow-sm whitespace-pre-wrap ${m.role === 'user' ? `bg-${book.color}-600 text-white rounded-br-none` : 'bg-white border text-gray-800 rounded-bl-none'}`}>
                                    <p className={m.role === 'model' ? 'font-serif text-lg' : ''}>{m.content}</p>
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef}></div>
                    </div>

                    <form onSubmit={handleSend} className="p-4 bg-white border-t flex gap-2 items-center">
                        <input 
                            type="text" 
                            value={input} 
                            onChange={(e) => setInput(e.target.value)} 
                            placeholder="Posez votre question..." 
                            className="flex-1 px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-amber-500"
                            disabled={isStreaming}
                        />
                        <button type="submit" disabled={isStreaming || !input.trim()} className={`px-6 py-3 bg-${book.color}-600 text-white rounded-full font-bold hover:opacity-90 disabled:opacity-50`}>
                            Envoyer
                        </button>
                    </form>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState(AppView.HOME);
            const [currentBook, setCurrentBook] = useState(null);
            const [selectedAuthor, setSelectedAuthor] = useState("Tous");
            const [showWelcome, setShowWelcome] = useState(true);
            
            const [apiKey, setApiKey] = useState(localStorage.getItem('GEMINI_API_KEY'));

            const handleSaveKey = () => {
                const key = prompt("Entrez votre cl√© API Google Gemini :");
                if (key) {
                    localStorage.setItem('GEMINI_API_KEY', key);
                    setApiKey(key);
                }
            };

            const openBook = (book, mode) => {
                setCurrentBook(book);
                setView(mode);
            };

            const goHome = () => {
                setCurrentBook(null);
                setView(AppView.HOME);
            };

            // Extraire les auteurs uniques
            const uniqueAuthors = ["Tous", ...new Set(LIBRARY.map(b => b.author))];

            // Filtrer les livres
            const filteredBooks = selectedAuthor === "Tous" 
                ? LIBRARY 
                : LIBRARY.filter(b => b.author === selectedAuthor);

            if (!CLE_UNIVERSELLE && !apiKey) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-amber-50">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                            <h1 className="text-3xl font-serif font-bold text-amber-900 mb-4">Bienvenue</h1>
                            <p className="text-gray-600 mb-6">Pour acc√©der √† la Biblioth√®que Spirite Universelle, une cl√© API Google Gemini (gratuite) est n√©cessaire.</p>
                            <button onClick={handleSaveKey} className="w-full py-3 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 transition">
                                Entrer ma Cl√© API
                            </button>
                            <p className="text-xs text-gray-400 mt-4">La cl√© est stock√©e uniquement sur votre appareil.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col max-w-7xl mx-auto bg-[#FDFBF7] shadow-2xl border-x border-gray-100 relative">
                    {/* Welcome Modal */}
                    {showWelcome && <WelcomeModal onClose={() => setShowWelcome(false)} />}

                    {/* Header */}
                    <header className="bg-white/90 backdrop-blur border-b p-4 flex items-center justify-between sticky top-0 z-50">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={goHome}>
                            <span className="text-2xl">üïäÔ∏è</span>
                            <div>
                                <h1 className="font-serif text-2xl font-bold text-gray-900 leading-none">Biblioth√®que Spirite</h1>
                                <p className="text-xs text-amber-600 font-bold tracking-widest uppercase">Intelligence Artificielle</p>
                            </div>
                        </div>
                        
                        {currentBook && (
                            <div className="hidden md:flex items-center gap-4">
                                <button onClick={() => setView(AppView.EXPLORER)} className={`px-4 py-2 rounded-full text-sm font-bold transition ${view === AppView.EXPLORER ? `bg-${currentBook.color}-100 text-${currentBook.color}-800` : 'text-gray-500 hover:bg-gray-100'}`}>
                                    üìñ Lire
                                </button>
                                <button onClick={() => setView(AppView.CHAT)} className={`px-4 py-2 rounded-full text-sm font-bold transition ${view === AppView.CHAT ? `bg-${currentBook.color}-100 text-${currentBook.color}-800` : 'text-gray-500 hover:bg-gray-100'}`}>
                                    üí¨ Discuter
                                </button>
                            </div>
                        )}
                    </header>

                    {/* Main */}
                    <main className="flex-1 p-4 md:p-6">
                        {view === AppView.HOME && (
                            <div className="animate-fade-in flex flex-col md:flex-row gap-6 h-full">
                                
                                {/* Sidebar Auteurs */}
                                <aside className="w-full md:w-64 flex-shrink-0">
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm sticky top-24">
                                        <h3 className="font-bold text-gray-900 mb-4 px-2 uppercase text-xs tracking-wider">Auteurs</h3>
                                        <nav className="flex flex-col space-y-1">
                                            {uniqueAuthors.map(author => (
                                                <button 
                                                    key={author}
                                                    onClick={() => setSelectedAuthor(author)}
                                                    className={`text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors ${selectedAuthor === author ? 'bg-amber-100 text-amber-900 font-bold' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}
                                                >
                                                    {author}
                                                </button>
                                            ))}
                                        </nav>
                                    </div>
                                </aside>

                                {/* Grille de livres */}
                                <div className="flex-1">
                                    <div className="mb-6">
                                        <h2 className="text-3xl font-serif text-gray-900">
                                            {selectedAuthor === "Tous" ? "Toute la Collection" : `≈íuvres de ${selectedAuthor}`}
                                        </h2>
                                        <p className="text-gray-500 font-serif italic mt-1">
                                            {filteredBooks.length} ouvrage(s) disponible(s)
                                        </p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                                        {filteredBooks.map(book => (
                                            <div key={book.id} className={`group bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-xl hover:border-${book.color}-300 transition-all duration-300 flex flex-col h-full`}>
                                                <div className="flex-1">
                                                    <h4 className={`font-serif text-2xl font-bold text-gray-900 group-hover:text-${book.color}-700 transition-colors`}>{book.title}</h4>
                                                    <p className="text-sm font-bold text-gray-500 mb-1">{book.author}</p>
                                                    <p className={`text-xs font-bold text-${book.color}-600 uppercase tracking-wider mb-3`}>{book.subtitle}</p>
                                                    <p className="text-gray-600 text-sm mb-6 line-clamp-4">{book.description}</p>
                                                </div>
                                                <div className="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                                                    <button onClick={() => openBook(book, AppView.EXPLORER)} className="flex-1 py-2 bg-gray-50 hover:bg-gray-100 text-gray-700 font-bold rounded-lg text-sm border transition-colors">
                                                        Feuilleter
                                                    </button>
                                                    <button onClick={() => openBook(book, AppView.CHAT)} className={`flex-1 py-2 bg-${book.color}-600 hover:bg-${book.color}-700 text-white font-bold rounded-lg text-sm transition-colors`}>
                                                        Parler
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === AppView.EXPLORER && currentBook && <ExplorerView book={currentBook} />}
                        {view === AppView.CHAT && currentBook && <ChatInterface book={currentBook} />}
                    </main>

                    {/* Footer */}
                    <footer className="p-6 text-center text-gray-400 text-sm border-t mt-8 bg-white">
                        <p>¬© 2025 - Biblioth√®que Spirite Universelle - Propuls√© par Google Gemini AI</p>
                        {!CLE_UNIVERSELLE && (
                            <button onClick={handleSaveKey} className="text-xs mt-2 underline hover:text-gray-600">
                                Changer la Cl√© API
                            </button>
                        )}
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
